<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Wolff Cluster Simulation (O(N) Model)</title>
<style>
:root {
  --bg: #0b1020; --panel: #0f172a; --panel-2: #111827;
  --text: #e5e7eb; --muted: #94a3b8;
  --accent: #60a5fa; --ring: #1f2937;
  --green: #34d399; --red: #f87171;
  --yellow: #facc15; --violet: #a78bfa;

  --colormap: linear-gradient(to right, cyan, black);
  --cluster-color: #61ffba;
}

*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans";
  color:var(--text);
  background:
    radial-gradient(1200px 900px at 10% -10%, #1b2548 0%, #0b1020 60%),
    radial-gradient(1000px 800px at 120% 10%, #12204a 0%, #0b1020 60%),
    var(--bg);
  background-attachment:fixed;
  background-size:cover;
}
.container{max-width:1200px;margin:0 auto;padding:24px}
h1{font-size:clamp(20px,3vw,32px);margin:0 0 8px;font-weight:650}
h2.subtitle{font-size:15px;color:var(--muted);margin-top:0;font-style:italic}
.grid{display:grid;grid-template-columns:1fr;gap:16px}
@media(min-width:980px){.grid{grid-template-columns:2fr 1fr}}
.card{
  background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
  border:1px solid var(--ring);border-radius:16px;
  box-shadow:0 10px 30px rgba(0,0,0,0.3);
}
.card h2{
  margin:0;padding:14px 16px;font-size:16px;letter-spacing:0.2px;
  border-bottom:1px solid var(--ring);
  background:rgba(255,255,255,0.02);
  border-radius:16px 16px 0 0;
}
.card .content{padding:16px}
.controls{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.controls .span2{grid-column:span 2}
.label{font-size:12px;color:var(--muted);margin-bottom:6px}
input[type="number"],select{
  width:100%;padding:8px 10px;border-radius:10px;
  border:1px solid var(--ring);background:var(--panel);color:var(--text);
}
.btns{display:flex;gap:8px;flex-wrap:wrap}
.btn{
  padding:8px 12px;border-radius:12px;border:1px solid var(--ring);
  background:var(--panel);color:var(--text);cursor:pointer;
  transition:.2s transform,.2s background;
}
.btn.primary{background:linear-gradient(180deg,#1e293b,#111827)}
.btn:hover{transform:translateY(-1px)}
canvas{display:block;width:100%;height:auto;image-rendering:pixelated}
.small{font-size:12px;color:var(--muted);margin-top:6px}
.pill{padding:4px 8px;border-radius:999px;background:#0b1327;border:1px solid var(--ring);
  font-size:11px;color:var(--muted)}
a {
  color: var(--accent);
  text-decoration: none;
  border-bottom: 1px solid transparent;
  transition: color 0.2s ease, border-bottom 0.2s ease;
}
a:hover { color: var(--green); border-bottom: 1px solid var(--green); }
a:visited { color: var(--violet); }
</style>
</head>
<body>
<div class="container">
  <h1>Wolff Cluster Simulation (O(N) Model)</h1>
  <h2 class="subtitle">by Atis Yosprakob</h2>

  <div class="grid">
    <div class="card">
      <h2>Spin Configuration (heatmap)</h2>
      <div class="content">
        <canvas id="canvas"></canvas>
        <div class="small" id="status"></div>
        <div class="small">Magnetic susceptibility ‚ü®œá‚ü©L‚Åª¬≤ = 
          <span id="susMean" class="pill">0.0000</span>
          ¬± <span id="susErr" class="pill">0.0000</span>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Controls</h2>
      <div class="content">
        <div class="controls">
          <div>
            <div class="label">O(N)</div>
            <select id="nSelect">
              <option value="1">1 (Ising)</option>
              <option value="2" selected>2 (XY)</option>
              <option value="3">3 (Heisenberg)</option>
            </select>
          </div>
          <div>
            <div class="label">Œ≤</div>
            <input type="number" id="betaInput" value="1.12" step="0.05" min="0.1" max="5">
          </div>
          <div>
            <div class="label">Speed</div>
            <input type="number" id="speedInput" value="1" min="1" max="500">
          </div>
          <div>
            <div class="label">Initialization</div>
            <select id="initSelect">
              <option value="cold" selected>Cold start</option>
              <option value="random">Random start</option>
            </select>
          </div>
          <div class="span2 btns">
            <button class="btn primary" id="startBtn">Start</button>
            <button class="btn" id="stopBtn">Stop</button>
            <span class="pill" id="stepCount">Steps: 0</span>
          </div>
        </div>
        <br>
        <div class="label">Critical points
          <br>&nbsp;&nbsp;&nbsp;Ising: 0.44068679351
          <br>&nbsp;&nbsp;&nbsp;XY: 1.12
          <br>&nbsp;&nbsp;&nbsp;Heisenberg: ‚àû
          <br><br>
          <a href="wolff1989.pdf" target="_blank">
            üìÑ Wolff (1989): Collective Monte Carlo Updating for Spin Systems
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<canvas id="colormapCanvas" width="256" height="1" style="display:none"></canvas>

<script>
const L=128,cellSize=3;
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
canvas.width=L*cellSize;canvas.height=L*cellSize;

let spins,inCluster,N,beta,speed,initType;
let running=false,stepCount=0;
let colormapLUT=[],clusterRGB=[255,255,0];
let chiSamples=[];

// ===== Colormap =====
function initColormap(){
  const cmapCanvas=document.getElementById('colormapCanvas');
  const cmapCtx=cmapCanvas.getContext('2d');
  const gradient=getComputedStyle(document.documentElement).getPropertyValue('--colormap').trim();
  const colors=gradient.replace(/linear-gradient\(.*?,(.*)\)/,'$1').split(',').map(s=>s.trim());
  const g=cmapCtx.createLinearGradient(0,0,cmapCanvas.width,0);
  colors.forEach((c,i)=>g.addColorStop(i/(colors.length-1),c));
  cmapCtx.fillStyle=g;cmapCtx.fillRect(0,0,cmapCanvas.width,1);
  const data=cmapCtx.getImageData(0,0,cmapCanvas.width,1).data;
  colormapLUT=[];
  for(let i=0;i<cmapCanvas.width;i++) colormapLUT.push([data[i*4],data[i*4+1],data[i*4+2]]);
  const ccolor=getComputedStyle(document.documentElement).getPropertyValue('--cluster-color').trim();
  const tmp=document.createElement('canvas');tmp.width=1;tmp.height=1;
  const tctx=tmp.getContext('2d');tctx.fillStyle=ccolor;tctx.fillRect(0,0,1,1);
  const cd=tctx.getImageData(0,0,1,1).data;clusterRGB=[cd[0],cd[1],cd[2]];
}
function colorFromValue(v){const idx=Math.floor(((v+1)/2)*255);return colormapLUT[Math.min(255,Math.max(0,idx))];}

// ===== Initialization =====
function initSpins(){
  if(initType==="cold")
    spins=Array.from({length:L},()=>Array.from({length:L},()=>Array.from({length:N},(_,i)=>(i===0?1:0))));
  else
    spins=Array.from({length:L},()=>Array.from({length:L},()=>randomUnitVector(N)));
  inCluster=Array.from({length:L},()=>Array(L).fill(false));
  chiSamples=[];
}
function randomUnitVector(n){
  if(n===1)return[Math.random()<0.5?1:-1];
  const v=Array.from({length:n},()=>Math.random()*2-1);
  const norm=Math.sqrt(v.reduce((a,b)=>a+b*b,0))||1;
  return v.map(x=>x/norm);
}

// ===== Cluster Update =====
function clusterUpdate(){
  for(let i=0;i<L;i++)inCluster[i].fill(false);
  const r=randomUnitVector(N);
  const i0=Math.floor(Math.random()*L),j0=Math.floor(Math.random()*L);
  const q=[[i0,j0]];inCluster[i0][j0]=true;reflect(spins[i0][j0],r);
  while(q.length){
    const [i,j]=q.shift();
    const s1=spins[i][j],dot1=dot(r,s1);
    const neigh=[[(i+1)%L,j],[(i-1+L)%L,j],[i,(j+1)%L],[i,(j-1+L)%L]];
    for(const [ni,nj] of neigh){
      if(inCluster[ni][nj])continue;
      const s2=spins[ni][nj],dot2=dot(r,s2);
      //const p=1-Math.exp(-2*beta*dot1*dot2);
      const prod = dot1 * dot2;
      const p = 1 - Math.exp(Math.min(0, 2 * beta * prod));

      if(Math.random()<p){inCluster[ni][nj]=true;reflect(s2,r);q.push([ni,nj]);}
    }
  }
}
function reflect(s,r){const d=dot(s,r);for(let k=0;k<s.length;k++)s[k]-=2*d*r[k];}
function dot(a,b){return a.reduce((s,ai,i)=>s+ai*b[i],0);}

// ===== Measure Susceptibility =====
function measureSusceptibility(){
  const M = new Array(N).fill(0);
  for (let i = 0; i < L; i++) for (let j = 0; j < L; j++)
    for (let k = 0; k < N; k++) M[k] += spins[i][j][k];
  const m2 = M.reduce((s, x) => s + x * x, 0) / (L * L);
  return m2 / (L * L); // matches printed œáL^-2 in your Fortran output
}


// ===== Stats =====
function updateStats(newVal){
  chiSamples.push(newVal);
  if(chiSamples.length>1000) chiSamples.shift();
  const n=chiSamples.length;
  if(n<2) return {mean:newVal,err:0};
  const mean=chiSamples.reduce((a,b)=>a+b,0)/n;
  const varsum=chiSamples.reduce((a,b)=>a+(b-mean)**2,0);
  const err=Math.sqrt(varsum/(n*(n-1)));
  return {mean,err};
}

// ===== Draw =====
function drawLattice(){
  const img=ctx.createImageData(canvas.width,canvas.height),data=img.data;
  for(let i=0;i<L;i++)for(let j=0;j<L;j++){
    const s=spins[i][j],val=Math.max(-1,Math.min(1,s[0]));
    const color=inCluster[i][j]?clusterRGB:colorFromValue(val);
    for(let dx=0;dx<cellSize;dx++)for(let dy=0;dy<cellSize;dy++){
      const x=i*cellSize+dx,y=j*cellSize+dy,idx=4*(y*canvas.width+x);
      data[idx]=color[0];data[idx+1]=color[1];data[idx+2]=color[2];data[idx+3]=255;
    }
  }
  ctx.putImageData(img,0,0);
}

// ===== Simulation Loop =====
async function simulate(){
  running=true;stepCount=0;
  const status=document.getElementById('status');
  const stepDisp=document.getElementById('stepCount');
  const susMean=document.getElementById('susMean');
  const susErr=document.getElementById('susErr');
  status.textContent="Thermalizing...";
  thermalize_steps=0;
  for(let t=0;t<500;t++)clusterUpdate();
  status.textContent="Running MCMC...";
  while(running){
    for(let k=0;k<speed;k++)clusterUpdate();
    const chi=measureSusceptibility();
    const {mean,err}=updateStats(chi);
    drawLattice();stepCount+=speed;
    stepDisp.textContent=`Steps: ${stepCount}`;
    status.textContent=`N=${N} ‚Ä¢ Œ≤=${beta.toFixed(2)} ‚Ä¢ Init=${initType}`;
    susMean.textContent=mean.toFixed(4);
    susErr.textContent=err.toFixed(4);
    await new Promise(r=>setTimeout(r,100));
  }
}

// ===== Controls =====
document.getElementById('startBtn').onclick=()=>{
  running=false;
  setTimeout(()=>{
    N=parseInt(document.getElementById('nSelect').value);
    beta=parseFloat(document.getElementById('betaInput').value);
    speed=parseInt(document.getElementById('speedInput').value);
    initType=document.getElementById('initSelect').value;
    initColormap();
    initSpins();
    drawLattice();
    simulate();
  },150);
};
document.getElementById('stopBtn').onclick=()=>{
  running=false;
  document.getElementById('status').textContent="Stopped.";
};
</script>
</body>
</html>
